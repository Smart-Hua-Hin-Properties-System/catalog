<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>HUAHIN.PROPERTIES</title>

  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root { --primary:#1a5276; --bg:#9CBCE3; --white:#fff; --green:#00d44b; --text:#2c3e50; --border:#eee; }
    html,body{font-family:'Kanit',sans-serif;background:var(--bg);margin:0;overflow-x:hidden;width:100%;}
    *{box-sizing:border-box}

    #loader-container{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:.5s}
    .emoji-group{display:flex;gap:15px;margin-bottom:25px;font-size:60px}
    .bounce{animation:bounce .6s infinite alternate}
    @keyframes bounce{from{transform:translateY(0)}to{transform:translateY(-20px)}}

    header{background:#fff;padding:12px 15px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .header-left{display:flex;align-items:center;gap:8px;cursor:pointer;color:var(--primary)}
    .flag-list{display:flex;gap:5px}
    .flag-btn{border:none;background:none;padding:0;cursor:pointer}
    .flag-btn img{width:24px;height:16px;border-radius:2px}

    .filter-area{padding:15px;width:100%;max-width:1200px;margin:0 auto}
    .filter-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;background:rgba(255,255,255,.9);padding:15px;border-radius:25px}
    @media(min-width:768px){.filter-grid{grid-template-columns:repeat(4,1fr)}}
    .select-box{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);font-family:'Kanit';color:var(--primary);font-size:.82rem}

    .property-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;padding:0 15px 40px;max-width:1200px;margin:0 auto}
    .card{background:var(--white);border-radius:40px;overflow:hidden;position:relative;box-shadow:0 15px 35px rgba(0,0,0,.1)}
    .badge{position:absolute;top:20px;left:20px;background:var(--green);color:#fff;padding:6px 18px;border-radius:50px;font-weight:500;font-size:.8rem;z-index:10}
    .card-img{width:100%;height:350px;object-fit:cover;background:#eee}
    .btn-detail{display:block;width:90%;margin:0 auto 20px;padding:14px;background:var(--primary);color:#fff;text-align:center;border-radius:50px;text-decoration:none;font-weight:500}
  </style>
</head>

<body>
  <div id="loader-container">
    <div class="emoji-group">
      <span class="bounce" style="animation-delay:0s">üè†</span>
      <span class="bounce" style="animation-delay:.2s">‚ú®</span>
      <span class="bounce" style="animation-delay:.4s">üå¥</span>
    </div>
    <div style="color:white;font-weight:900;font-size:1.5rem;">HUAHIN.PROPERTIES</div>
  </div>

  <header>
    <div class="header-left">
      <i class="fas fa-bars fa-lg"></i>
      <span style="font-size:.85rem;font-weight:500;margin-left:5px;">‡πÄ‡∏°‡∏ô‡∏π</span>
    </div>
    <div style="font-weight:900;color:var(--primary);font-size:.9rem;">HUAHIN.PROPERTIES</div>
    <div class="flag-list">
      <button class="flag-btn" onclick="setLanguage('th')"><img src="https://flagcdn.com/w40/th.png"></button>
      <button class="flag-btn" onclick="setLanguage('en')"><img src="https://flagcdn.com/w40/us.png"></button>
    </div>
  </header>

  <div class="filter-area">
    <div class="filter-grid">
      <select class="select-box" id="distFilter" onchange="updateSubDistricts()">
        <option value="">üìç ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô">‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô</option>
        <option value="‡∏ä‡∏∞‡∏≠‡∏≥">‡∏ä‡∏∞‡∏≠‡∏≥</option>
        <option value="‡∏õ‡∏£‡∏≤‡∏ì‡∏ö‡∏∏‡∏£‡∏µ">‡∏õ‡∏£‡∏≤‡∏ì‡∏ö‡∏∏‡∏£‡∏µ</option>
      </select>

      <select class="select-box" id="subDistFilter" onchange="applyFilters()">
        <option value="">üèòÔ∏è ‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      </select>

      <select class="select-box" id="bedFilter" onchange="applyFilters()">
        <option value="">üõå ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="1">1+</option><option value="2">2+</option><option value="3">3+</option>
        <option value="4">4+</option><option value="5">5+</option><option value="6">6+</option>
      </select>

      <select class="select-box" id="priceSort" onchange="applyFilters()">
        <option value="">üí∞ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤</option>
        <option value="low">‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å</option>
        <option value="high">‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢</option>
      </select>
    </div>
  </div>

  <div class="property-grid" id="grid"></div>

  <script>
    // ‚úÖ ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const api = "https://script.google.com/macros/s/AKfycbzkweiEgczmmU_4FiqRffJ4exvgZl3RwGPIBWXssLgkUpdMArif9-eUEv6yP2Kvtzh1/exec";

    let allData = [];
    let currentLang = localStorage.getItem("smartLang") || "th";

    const i18n = {
      th: { view:"‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" },
      en: { view:"View Details" }
    };

    function setLanguage(lang){
      currentLang = lang;
      localStorage.setItem("smartLang", lang);
      applyFilters();
    }

    function safeImg(url){
      if(!url) return "https://placehold.co/600x800";
      if(url.includes("lh3.googleusercontent.com/d/")) return url;
      if(url.includes("id=")) return url.replace("id=","export=view&id=");
      return url;
    }

    async function init(){
      try{
        const res = await fetch(`${api}?role=PUBLIC`);
        allData = await res.json();

        // ‚úÖ ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ API ‡∏™‡πà‡∏á error object
        if(!Array.isArray(allData)){
          document.getElementById("grid").innerHTML = "Error: API not returning list";
          return;
        }

        // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à -> render
        updateSubDistricts(true);

        document.getElementById("loader-container").style.opacity="0";
        setTimeout(()=>document.getElementById("loader-container").style.display="none",500);
      }catch(e){
        document.getElementById("grid").innerHTML = "Error Connecting to Database";
      }
    }

    function updateSubDistricts(isFirstLoad=false){
      const d = document.getElementById("distFilter").value;
      const sSel = document.getElementById("subDistFilter");

      // reset
      sSel.innerHTML = `<option value="">üèòÔ∏è ‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;

      if(d){
        // ‚úÖ ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡∏ö‡∏•‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á ‡πÇ‡∏î‡∏¢‡∏î‡∏π‡∏à‡∏≤‡∏Å District/SubDistrict (‡∏ó‡∏µ‡πà Apps Script normalize ‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß)
        const subs = [...new Set(
          allData
            .filter(it => String(it.District || "").trim() === d)
            .map(it => String(it.SubDistrict || "").trim())
        )]
        .filter(x => x && x !== "-")
        .sort((a,b)=>a.localeCompare(b,"th"));

        subs.forEach(s=>{
          sSel.innerHTML += `<option value="${s}">${s}</option>`;
        });
      }

      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ -> reset ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á
      if(!isFirstLoad) sSel.value = "";

      applyFilters();
    }

    function renderGrid(items){
      const grid = document.getElementById("grid");
      grid.innerHTML = "";

      if(items.length === 0){
        grid.innerHTML = `<div style="padding:20px;color:#1a5276;font-weight:600;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ</div>`;
        return;
      }

      items.forEach(it=>{
        const img = safeImg(it.Thumbnail);
        const price = Number(it.Price || 0).toLocaleString();
        const btnText = (i18n[currentLang] || i18n.th).view;

        grid.innerHTML += `
          <div class="card">
            <div class="badge">CODE: ${it.ID || ""}</div>
            <img src="${img}" class="card-img"
                 loading="lazy" decoding="async"
                 onerror="this.src='https://placehold.co/600x800'">
            <div style="padding:18px 18px 0;">
              <div style="font-size:.8rem;color:#888;margin-bottom:5px;">${it.Project_Name || "HUAHIN"}</div>
              <div style="font-size:1.8rem;color:var(--primary);font-weight:600;margin-bottom:20px;">‡∏ø${price}</div>
            </div>
            <a href="details.html?id=${encodeURIComponent(it.HP_ID)}" class="btn-detail">${btnText}</a>
          </div>
        `;
      });
    }

    function applyFilters(){
      let data = [...allData];

      const d = document.getElementById("distFilter").value;
      const s = document.getElementById("subDistFilter").value;
      const b = document.getElementById("bedFilter").value;
      const sort = document.getElementById("priceSort").value;

      if(d) data = data.filter(it => String(it.District || "").trim() === d);
      if(s) data = data.filter(it => String(it.SubDistrict || "").trim() === s);

      if(b){
        const bb = Number(b);
        data = data.filter(it => Number(it.Bedrooms || 0) >= bb);
      }

      if(sort === "low") data.sort((a,b)=>Number(a.Price||0)-Number(b.Price||0));
      if(sort === "high") data.sort((a,b)=>Number(b.Price||0)-Number(a.Price||0));

      renderGrid(data);
    }

    window.onload = init;
  </script>
</body>
</html>
