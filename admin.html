<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Reality Portal V4.7</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #1a5276; --bg: #f4f7f6; --green: #27ae60; --orange: #e67e22; --red: #e74c3c; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg); margin: 0; font-weight: 300; }
        .admin-header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .nav-tabs { background: #fff; display: flex; border-bottom: 1px solid #eee; position: sticky; top: 58px; z-index: 999; }
        .tab-item { padding: 15px; color: #7f8c8d; text-decoration: none; font-size: 0.85rem; flex: 1; text-align: center; border-bottom: 3px solid transparent; cursor: pointer; transition: 0.3s; }
        .tab-item.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 400; }
        .container { padding: 20px; max-width: 1000px; margin: 0 auto; }
        .card { background: #fff; border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .badge { padding: 4px 10px; border-radius: 50px; font-size: 0.7rem; }
        .waiting { background: #fff3cd; color: #856404; }
        .active-st { background: #d4edda; color: #155724; }
        .blacklist { background: #f8d7da; color: #721c24; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #eee; color: var(--primary); }
        td { padding: 12px; border-bottom: 1px solid #f5f5f5; }
        .btn-approve { background: var(--green); color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-family: 'Kanit'; }
    </style>
</head>
<body>

<div class="admin-header">
    <div style="font-weight:400;">SMART SYSTEM <span id="projectLabel" style="font-size:0.7rem; opacity:0.8;"></span></div>
    <button onclick="logout()" style="background:var(--red); color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">LOGOUT</button>
</div>

<div class="nav-tabs">
    <div class="tab-item active" onclick="showTab('property', this)"><i class="fas fa-home"></i> ทรัพย์สิน</div>
    <div class="tab-item" onclick="showTab('agent', this)"><i class="fas fa-users-cog"></i> ทะเบียน Agent</div>
    <div class="tab-item" onclick="showTab('visit', this)"><i class="fas fa-satellite-dish"></i> GPS Tracking</div>
</div>

<div class="container">
    <div id="propertySection" class="tab-content">
        <h3 style="font-weight:400; color:var(--primary);">จัดการรายการบ้าน</h3>
        <div id="propertyList"></div>
    </div>

    <div id="agentSection" class="tab-content" style="display:none;">
        <div class="card">
            <h3 style="margin-top:0; font-weight:400;">บัญชีรายชื่อ Agent มหาอำนาจ (15 รายการ)</h3>
            <table>
                <thead><tr><th>PIN</th><th>ชื่อ Agent / สังกัด</th><th>คำเตือน</th><th>สถานะ</th></tr></thead>
                <tbody id="agentBody"></tbody>
            </table>
        </div>
    </div>

    <div id="visitSection" class="tab-content" style="display:none;">
        <h3 style="font-weight:400; color:var(--primary);">ประวัติเช็คอินและพิกัด GPS จริง</h3>
        <div id="visitList"></div>
    </div>
</div>

<script>
    const api = "https://script.google.com/macros/s/AKfycbyd68dXse7OuwzfIRgHYDRIGHRQPIXnYOBK2fxHTqeJoYQYLYbP2HZkOGUaPxIaahIS/exec";
    const user = JSON.parse(localStorage.getItem('smartAdmin'));
    if(!user) window.location.href = 'login.html';
    document.getElementById('projectLabel').innerText = "| " + user.projectName;

    function showTab(t, el) {
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
        document.getElementById(t + 'Section').style.display = 'block';
        el.classList.add('active');
        if(t === 'agent') loadAgents();
        if(t === 'visit') loadVisits();
    }

    async function loadAgents() {
        const r = await fetch(api + "?action=getAllAgents");
        const data = await r.json();
        document.getElementById('agentBody').innerHTML = data.map(a => `
            <tr>
                <td><b>${a.Agent_PIN}</b></td>
                <td>${a.Agent_Name}<br><small style="color:#777;">${a.Agency}</small></td>
                <td><span style="color:${a.Warnings > 1 ? 'var(--red)' : '#333'}">${a.Warnings} ครั้ง</span></td>
                <td><span class="badge ${a.Status.toLowerCase() === 'active' ? 'active-st' : 'blacklist'}">${a.Status}</span></td>
            </tr>`).join('');
    }

    async function loadVisits() {
        const r = await fetch(`${api}?action=getVisitLogs&projectName=${encodeURIComponent(user.projectName)}&role=${user.role}`);
        const data = await r.json();
        document.getElementById('visitList').innerHTML = data.map(v => `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:400; color:var(--primary);">${v.Agent_Name}</div>
                    <div style="font-size:0.8rem; color:#777; margin:4px 0;">
                        <i class="far fa-clock"></i> ${new Date(v.Timestamp).toLocaleString('th-TH')} | <b>ID:</b> ${v.Marketing_ID}
                    </div>
                    <a href="https://www.google.com/maps?q=${v.Lat},${v.Lng}" target="_blank" style="font-size:0.75rem; color:var(--orange); text-decoration:none;"><i class="fas fa-map-marked-alt"></i> พิกัดจริง: ${v.Lat},${v.Lng}</a>
                </div>
                <div style="text-align:right;">
                    <span class="badge ${v.Status === 'Waiting' ? 'waiting' : 'active-st'}">${v.Status === 'Waiting' ? 'รออนุมัติ' : 'อนุมัติแล้ว'}</span>
                    ${v.Status === 'Waiting' ? `<div style="margin-top:10px;"><button class="btn-approve" onclick="approve('${v.Log_ID}')">Approve</button></div>` : `<div style="font-size:0.65rem; color:var(--green); margin-top:5px;">โดย: ${v.Approved_By}</div>`}
                </div>
            </div>`).join('');
    }

    async function approve(id) {
        if(!confirm("ยืนยันการเข้าชมจริงตามพิกัด GPS?")) return;
        await fetch(api, { method: 'POST', body: JSON.stringify({ action: 'approveVisit', logId: id, approvedBy: user.projectName }) });
        alert("อนุมัติสำเร็จ!"); loadVisits();
    }

    function logout() { localStorage.removeItem('smartAdmin'); window.location.href = 'login.html'; }
    showTab('property', document.querySelector('.tab-item'));
</script>
</body>
</html>
